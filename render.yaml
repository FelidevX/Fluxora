# render.yaml (Versión final y funcional)
services:
  # 1. Base de datos PostgreSQL (Render Managed Database)
  # El tipo 'pserv' solo acepta las propiedades listadas.
  - type: pserv
    name: fluxora-db
    plan: starter
    disk:
      name: postgres-data
      sizeGB: 10
    # **IMPORTANTE:** En un 'pserv', las credenciales se definen como envVars
    # para que Render sepa qué credenciales debe usar al crear la DB
    envVars:
      - key: DATABASE_NAME
        value: fluxora_db
      - key: USER
        value: fluxora
      - key: PASSWORD # Render usa esta clave para la contraseña
        generateValue: true # Genera una contraseña segura automáticamente

  # 2. Servidor de Descubrimiento (Eureka Server)
  - type: web
    name: eureka-server
    rootDir: ./Microservicios/microservice-eureka
    plan: starter
    buildCommand: ./mvnw clean install -DskipTests
    startCommand: java -jar target/*.jar
    # **CORRECCIÓN CLAVE:** El puerto se define como una variable de entorno,
    # y la aplicación debe estar configurada para usar $PORT
    envVars:
      - key: PORT
        value: 8761
    
  # 3. Microservicios de Backend (Internos)
  - type: web
    name: cliente-service
    rootDir: ./Microservicios/microservice-cliente
    plan: starter
    buildCommand: ./mvnw clean install -DskipTests
    startCommand: java -jar target/*.jar
    envVars:
      - key: PORT
        value: 8083 # Puerto interno
      - key: EUREKA_SERVER_URL
        value: http://eureka-server:8761/eureka/ # Comunicación interna a Eureka

  - type: web
    name: usuario-service
    rootDir: ./Microservicios/microservice-usuario
    plan: starter
    buildCommand: ./mvnw clean install -DskipTests
    startCommand: java -jar target/*.jar
    envVars:
      - key: PORT
        value: 8081

  - type: web
    name: entrega-service
    rootDir: ./Microservicios/microservice-entrega
    plan: starter
    buildCommand: ./mvnw clean install -DskipTests
    startCommand: java -jar target/*.jar
    envVars:
      - key: PORT
        value: 8084

  - type: web
    name: inventario-service
    rootDir: ./Microservicios/microservice-inventario
    plan: starter
    buildCommand: ./mvnw clean install -DskipTests
    startCommand: java -jar target/*.jar
    envVars:
      - key: PORT
        value: 8082
    
  # 4. API Gateway (Punto de acceso público al Backend)
  - type: web
    name: api-gateway
    rootDir: ./Microservicios/microservice-gateway
    plan: starter
    buildCommand: ./mvnw clean install -DskipTests
    startCommand: java -jar target/*.jar
    envVars:
      - key: PORT
        value: 8080 # Puerto público

  # 5. Frontend Next.js (Punto de acceso para usuarios)
  - type: web
    name: frontend-fluxora
    rootDir: ./frontend-fluxora
    plan: starter
    # Para Node.js/Next.js, el puerto por defecto es 10000, 
    # pero puedes forzarlo si tu app lo necesita
    envVars:
      - key: PORT
        value: 3000
    buildCommand: npm install && npm run build
    startCommand: npm start